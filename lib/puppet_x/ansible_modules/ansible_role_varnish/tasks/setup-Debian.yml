---
- name: Configure packagecloud.io repository
  block:
    - name: Ensure dependencies are present.
      apt:
        name:
          - apt-transport-https
          - gnupg2
        state: present

    # apt-key is deprecated and absent since debian 13 (trixie).
    # The new way to do this without adding an extra gpg --dearmor task is to use get_url to download the file
    # into the trusted.gpg.d folder with the .asc filename
    - name: Add packagecloud.io Varnish apt key.
      ansible.builtin.get_url:
        url: https://packagecloud.io/varnishcache/{{ varnish_packagecloud_repo }}/gpgkey
        dest: /etc/apt/trusted.gpg.d/varnishcache_{{ varnish_packagecloud_repo }}-archive-keyring.asc
        mode: '0644'
        force: true

    - name: Add packagecloud.io Varnish apt repository.
      apt_repository:
        repo: "{{ varnish_apt_repo }}"
        state: present
  when: varnish_apt_use_packagecloud

- name: Ensure Varnish is installed.
  apt:
    name: "{{ varnish_package_name }}"
    state: present

- name: Ensure Varnish VMODs are installed.
  apt:
    name: "{{ varnish_modules_package_name }}"
    state: present
  when: varnish_modules_package_name | length > 0
